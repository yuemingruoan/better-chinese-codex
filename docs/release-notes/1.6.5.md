# 1.6.5 版本说明

发布日期：2026-01-17

本版本将 fork 的 1.6.x 变更与上游 rust-v0.84.0 合并，重点覆盖协议/工具能力、TUI 体验、执行与沙箱稳定性、线程（thread）能力与配置体系等。

## 亮点
- **协议与类型增强**：文本元素新增元数据字段，为更丰富的客户端渲染与协议演进做准备。
- **协作与工具能力**：新增 collab 相关工具与事件；WebSearchMode 枚举与工具行为完善；Responses SSE 事件处理更及时。
- **TUI/TUI2 体验**：底部栏 token 用量展示、复制选择与粘贴体验改进、退出与状态展示更一致。
- **执行与沙箱**：PTY 失效时可用管道进程替代；Linux 沙箱支持只读绑定挂载并修复 uid/gid 映射问题。

## 主要更新
### 协议与 API
- 文本元素元数据扩展（协议/类型结构更新）。
- 线程（thread）能力完善：fork、rollback、list 等流程与测试覆盖。
- Responses SSE 与 WebSocket 流式事件处理增强（含完成事件更及时、解析与错误处理改进）。
- 输出 schema 与工具事件增强（包括 tool event 与请求/响应结构补充）。

### 工具与执行
- PTY 不可用时使用管道进程替代，提升稳定性与兼容性。
- ExecPolicy 逻辑与提示改进（含审批、命令解析与提示文本优化）。
- 改善工具调用日志与诊断信息（trace header、错误上下文等）。

### TUI / TUI2
- 底部栏新增/优化 token 用量展示与提示。
- 复制选择体验增强（选择范围、可视反馈、滚动/拖拽行为等）。
- 粘贴/输入节流与状态机更稳健，避免异常输入场景。
- 退出与按键行为一致性改进（例如双击退出、快捷键对齐）。

### 配置与运维
- 配置层级体系强化（ConfigLayerStack）、支持项目根标记与系统级 `/etc/codex/config.toml`。
- 模型配置与缓存策略更新（models.json、缓存 TTL 与离线缓存逻辑）。
- 指标/分析相关能力扩展（可配置的 analytics 与指标上报路径）。

### 开发与构建
- Bazel 构建支持增强（含补丁与脚本）。
- 配置 schema 生成与文档补充。
- 测试覆盖加强（websocket、thread、exec、TUI/TUI2 等）。

## 修复
- 修复 Linux 沙箱 uid/gid 映射、Windows 终端/编码与 exec 相关问题。
- 修复 TUI/TUI2 状态展示、粘贴与队列提示等交互边缘问题。
- 修复 Responses SSE 完成事件时序与部分工具事件异常。

## 兼容性与注意事项
- 线程（thread）命名与接口相关调整可能影响旧脚本/测试，请关注相关 API/字段变更。
- 配置层级与默认值有更新，建议对照 `docs/config.md` 复核本地配置。
- 本 fork 保留对 API 用户更宽松的模型可用性策略。

