# Windows 沙箱安全说明

有关 Codex 沙箱机制的整体背景，请参阅 [sandbox.md](./sandbox.md)。

## 实现概览

当通过 `codex sandbox windows …` 运行命令（或 CLI/TUI 在同一进程中调用该 crate 进入沙箱回合）时，启动器会配置受限的 Windows 访问令牌，并基于工作区根目录建立白名单策略。除已声明的根目录（以及在 workspace-write 模式下的 `%TEMP%`）外，其余路径全部禁止写入，同时会主动拦截常见逃逸手段，例如备用数据流（ADS）、UNC 路径以及设备句柄。CLI 还会在宿主 PATH 之前注入桩程序（如包装 `ssh`），以便在危险工具离开沙箱前就将其截获。

## 已知安全局限

在拥有完整文件系统与网络访问权限的情况下运行 `python windows-sandbox-rs/sandbox_smoketests.py`，目前 **41 项中仅 37 项通过**。下表聚焦于烟雾测试序号 #32 及之后的四个高优先级失败案例（此前的测试与安全关系较小）。

| 测试项                                      | 目的说明                                                                                                                                                                                                                                                                  |
| ------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| ADS 写入被拒（#32）                         | 确保无法在工作区内写入备用数据流，防止工具把有效负载藏在 ADS 中。目前沙箱仍允许写入（进程返回 `rc=0`）。                                                                                                                                                                |
| 保护路径大小写变体被拒（#33）               | 确认受保护目录（如 `.git`）在攻击者使用大小写技巧（例如 `.GiT`）时仍保持阻断。当前白名单会把 `.GiT` 视作不同路径，因此写入会成功。                                                                                                                                    |
| PATH 桩程序绕过被拒（#35）                  | 验证工作区提供的 `ssh.bat` 桩脚本若被放在 PATH 前端，会优先运行而非真正的 `ssh`。目前沙箱会过早退出，无法输出桩脚本的 `stubbed`，因此无法证明拦截有效。                                                                                                             |
| Start-Process https 被拒（KNOWN FAIL，#41） | 确认只读模式下不能通过 `Start-Process 'https://…'` 启动宿主默认浏览器。现阶段该命令会成功（退出码 0），因为 Explorer 会在沙箱外处理 ShellExecute 请求。此失败由 `windows-sandbox-rs/sandbox_smoketests.py`（最后一项）记录。 |

## 如何贡献？

如果你是关注安全的 Windows 用户，欢迎帮助我们修复这些测试！让烟雾测试完全通过可以显著降低 Codex 的逃逸面。完成改进后，请重新运行 `python windows-sandbox-rs/sandbox_smoketests.py` 验证，帮助我们将结果提升到 41/41。
