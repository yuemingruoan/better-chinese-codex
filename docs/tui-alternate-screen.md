# TUI 备用屏幕与终端复用器

## 概览

本文解释 Codex 对备用屏幕（alternate screen）的设计决策，尤其是在 Zellij 等终端复用器中。
该问题源于全屏 TUI 行为与终端回滚历史保存之间的根本冲突。

## 问题

### 全屏 TUI 的好处

Codex 的 TUI 使用终端的 **备用屏幕缓冲区** 来提供干净的全屏体验。该方式：

- 使用完整视口而不污染终端回滚历史
- 为聊天界面提供独立环境
- 与其他终端应用（vim、tmux 等）行为一致

### 与 Zellij 的冲突

像 **Zellij** 这样的终端复用器严格遵循 xterm 规范，该规范规定备用屏幕 **不应有回滚历史**。
这是设计选择而非 bug：

- **Zellij PR：** https://github.com/zellij-org/zellij/pull/1032
- **依据：** xterm 规范明确说明备用屏幕模式不允许回滚
- **可配置性：** Zellij 不提供在备用屏幕中启用回滚的选项

当在 Zellij 中使用 Codex TUI 时，用户无法通过终端滚动回看对话历史，因为：

1. TUI 在备用屏幕模式运行（全屏）
2. Zellij 在备用屏幕中禁用回滚（遵循 xterm 规范）
3. 整段对话无法通过常规终端滚动访问

## 解决方案

Codex 提供一个 **务实的折中方案**，通过 `config.toml` 的 `tui.alternate_screen` 控制三种模式：

### 1. `auto`（默认）

- **行为：** 自动检测终端复用器
- **在 Zellij 中：** 关闭备用屏幕（行内模式，保留回滚）
- **其他情况：** 启用备用屏幕（全屏体验）
- **理由：** 在不同环境下提供最佳体验

### 2. `always`

- **行为：** 始终使用备用屏幕（原始行为）
- **适用：** 偏好全屏且不使用 Zellij，或已找到解决方案的用户

### 3. `never`

- **行为：** 从不使用备用屏幕（行内模式）
- **适用：** 始终希望保留回滚历史的用户
- **代价：** TUI 输出会污染终端回滚

## 运行时覆盖

可使用 `--no-alt-screen` CLI 参数在运行时覆盖配置：

```bash
codex --no-alt-screen
```
